<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"><link rel="stylesheet" href="../custom.css"><div class="middle-column">
 <section id="overview">
  <h1 class="hckui__typography__h1" itemprop="name">
   Smart Cabinets with a Custom Smart Home
  </h1>
  <p class="hckui__typography__bodyL hckui__layout__marginBottom15" itemprop="description">
   Automatic/Smart Cabinets that are voice activated through a custom Smart Home network.
  </p>
  <div class="hckui__layout__marginTop30">
   <div class="hckui__layout__hiddenMedUp">
   </div>
   <div class="project-cover-image" itemprop="image" itemscope="" itemtype="https://schema.org/ImageObject">
    <meta content="https://hackster.imgix.net/uploads/attachments/1755864/_WcjO3AZXun.blob?auto=compress&amp;w=900&amp;h=675&amp;fit=min&amp;fm=jpg" itemprop="url"/>
    <meta content="900" itemprop="width"/>
    <meta content="675" itemprop="height"/>
    <img alt="Smart Cabinets with a Custom Smart Home" src="7.jpg"/>
   </div>
  </div>
 </section>
 <div class="project-section-break">
 </div>
 <div id="project_page_simple_ad_portal">
 </div>
 <div id="description" itemprop="articleBody">
  <section id="things">
   <div class="project-section-title">
    <h2 class="hckui__typography__h2 title-with-anchor">
     <span>
      Things used in this project
     </span>
    </h2>
   </div>
   <div class="project-parts">
    <div class="view-expanded" style="display:block">
     <table class="project-parts-table">
      <colgroup>
       <col style="width: 100px; height: 50px;"/>
       <col style="width: auto;"/>
      </colgroup>
      <tbody>
       <tr class="head">
        <td colspan="2">
         <h3 class="hckui__typography__h3">
          Hardware components
         </h3>
        </td>
        <tr>
         <td class="part-img">
         </td>
         <td class="hckui__typography__bodyL">
          M5Stack CM4Stack Development Kit
         </td>
        </tr>
        <tr>
         <td class="part-img">
          <img alt="UNIHIKER - IoT Python Programming Single Board Computer with Touchscreen" src="8.jpg" srcset="https://hackster.imgix.net/uploads/attachments/1623050/9924dc25f8a8d36cae2ea2becac95b77_Bn8OXLjRQw.png?auto=compress%2Cformat&amp;w=96&amp;h=96&amp;fit=fill&amp;bg=ffffff 2x, https://hackster.imgix.net/uploads/attachments/1623050/9924dc25f8a8d36cae2ea2becac95b77_Bn8OXLjRQw.png?auto=compress%2Cformat&amp;w=48&amp;h=48&amp;fit=fill&amp;bg=ffffff"/>
         </td>
         <td class="hckui__typography__bodyL">
          <a class="hckui__typography__linkBlue" data-ha='{"eventName":"Clicked link","customProps":{"value":"DFRobot UNIHIKER - IoT Python Programming Single Board Computer with Touchscreen","href":"/dfrobot/products/unihiker-iot-python-programming-single-board-computer-with-touchscreen1?ref=project-6382bc","type":"part","location":"things"},"clickOpts":{"delayRedirect":true}}' href="https://www.hackster.io/dfrobot/products/unihiker-iot-python-programming-single-board-computer-with-touchscreen1?ref=project-6382bc">
           DFRobot UNIHIKER - IoT Python Programming Single Board Computer with Touchscreen
          </a>
         </td>
        </tr>
        <tr>
         <td class="part-img">
          <img alt="FireBeetle ESP32 IOT Microcontroller (Supports Wi-Fi &amp; Bluetooth)" src="9.jpg" srcset="https://hackster.imgix.net/uploads/attachments/715627/DFR0478-45%E5%BA%A6900x600-450x300.jpg?auto=compress%2Cformat&amp;w=96&amp;h=96&amp;fit=fill&amp;bg=ffffff 2x, https://hackster.imgix.net/uploads/attachments/715627/DFR0478-45%E5%BA%A6900x600-450x300.jpg?auto=compress%2Cformat&amp;w=48&amp;h=48&amp;fit=fill&amp;bg=ffffff"/>
         </td>
         <td class="hckui__typography__bodyL">
          <a class="hckui__typography__linkBlue" data-ha='{"eventName":"Clicked link","customProps":{"value":"DFRobot FireBeetle ESP32 IOT Microcontroller (Supports Wi-Fi \u0026 Bluetooth)","href":"/dfrobot/products/firebeetle-esp32-iot-microcontroller-supports-wi-fi-bluetooth?ref=project-6382bc","type":"part","location":"things"},"clickOpts":{"delayRedirect":true}}' href="https://www.hackster.io/dfrobot/products/firebeetle-esp32-iot-microcontroller-supports-wi-fi-bluetooth?ref=project-6382bc">
           DFRobot FireBeetle ESP32 IOT Microcontroller (Supports Wi-Fi &amp; Bluetooth)
          </a>
         </td>
        </tr>
        <tr>
         <td class="part-img">
          <img alt="Ultrasonic Sensor - HC-SR04 (Generic)" src="10.jpg" srcset="https://hackster.imgix.net/uploads/attachments/182875/51GZZ5EU9PL._SX425_.jpg?auto=compress%2Cformat&amp;w=96&amp;h=96&amp;fit=fill&amp;bg=ffffff 2x, https://hackster.imgix.net/uploads/attachments/182875/51GZZ5EU9PL._SX425_.jpg?auto=compress%2Cformat&amp;w=48&amp;h=48&amp;fit=fill&amp;bg=ffffff"/>
         </td>
         <td class="hckui__typography__bodyL">
          Ultrasonic Sensor - HC-SR04 (Generic)
         </td>
        </tr>
        <tr>
         <td class="part-img">
          <img alt="SG90 Micro-servo motor" src="11.jpg" srcset="https://hackster.imgix.net/uploads/attachments/657402/SG90-Servo-Motor-180-Degrees-SG90-Micro.jpg?auto=compress%2Cformat&amp;w=96&amp;h=96&amp;fit=fill&amp;bg=ffffff 2x, https://hackster.imgix.net/uploads/attachments/657402/SG90-Servo-Motor-180-Degrees-SG90-Micro.jpg?auto=compress%2Cformat&amp;w=48&amp;h=48&amp;fit=fill&amp;bg=ffffff"/>
         </td>
         <td class="hckui__typography__bodyL">
          SG90 Micro-servo motor
         </td>
        </tr>
       </tr>
       <tr class="head">
        <td colspan="2">
         <h3 class="hckui__typography__h3">
          Software apps and online services
         </h3>
        </td>
       </tr>
       <tr>
        <td class="part-img">
         <img alt="Arduino IDE" src="12.jpg" srcset="https://hackster.imgix.net/uploads/image/file/144203/IDE_web.jpg?auto=compress%2Cformat&amp;w=96&amp;h=96&amp;fit=fill&amp;bg=ffffff 2x, https://hackster.imgix.net/uploads/image/file/144203/IDE_web.jpg?auto=compress%2Cformat&amp;w=48&amp;h=48&amp;fit=fill&amp;bg=ffffff"/>
        </td>
        <td class="hckui__typography__bodyL">
         <a class="hckui__typography__linkBlue" data-ha='{"eventName":"Clicked link","customProps":{"value":"Arduino IDE","href":"/arduino/products/arduino-ide?ref=project-6382bc","type":"part","location":"things"},"clickOpts":{"delayRedirect":true}}' href="https://www.hackster.io/arduino/products/arduino-ide?ref=project-6382bc">
          Arduino IDE
         </a>
        </td>
       </tr>
       <tr>
        <td class="part-img">
        </td>
        <td class="hckui__typography__bodyL">
         DFRobot Mind+
        </td>
       </tr>
       <tr>
        <td class="part-img">
        </td>
        <td class="hckui__typography__bodyL">
         Thonny
        </td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
  </section>
  <div class="project-section-break">
  </div>
  <section id="story">
   <div class="project-section-title">
    <h2 class="hckui__typography__h2 title-with-anchor">
     <span>
      Story
     </span>
    </h2>
   </div>
   <div class="project-story collapsible-section collapsed hljs-active hljs-monokai" itemprop="text">
    <h3>
    </h3>
    <div class="embed-frame">
     <figure class="youtube">
      <iframe allowfullscreen="" frameborder="0" height="500" src="//www.youtube.com/embed/wozcRePXfto?rel=0" style="margin: 10px auto; display: block;" width="75%">
      </iframe>
     </figure>
    </div>
    <h3 class="hckui__typography__h3 title-with-anchor" id="toc-first-things-first-0">
     <p>
      <p class="hckui__typography__bodyL">
      </p>
     </p>
     <span>
      First Things First
     </span>
    </h3>
    <p class="hckui__typography__bodyL">
     My initial pitch for what I could provide to help mobility impaired individuals revolved around smart gadgets for the kitchen, so this project stays within that realm.  This project is part of the Build2gether challenge which offers feedback on the initial ideas and it was conveyed that improvements to cabinetry would be the most helpful to those with mobility related disabilities.  A lot of the issues with cabinets and the kitchen as a whole seem to be in layout and design, which makes sense.  It'd be frustrating to have things be just out of reach, or to try to open a cabinet and your wheelchair is in the way.  One aspect that I'm able to tackle, though, is the way cabinetry is controlled in the first place.  With technology we can open and close cabinets with more convenient systems and remove the inconveniences that mobility impaired people experience. That's only part of the picture, though.  This project will be about not only creating Smart/Automatic Cabinets, but also putting together a forward thinking Smart Kitchen solution that could be easily leveraged to add more devices as well as making these custom devices easier to utilize.
    </p>
    <p class="hckui__typography__bodyL">
     We'll go through each piece of  the setup step by step, but I want to provide a quick overview of the goal as a whole.  There are 3 main parts.
    </p>
    <p class="hckui__typography__bodyL">
     1. Device(s) to kick off the process to tell the cabinet(s) to open/close in the first place
    </p>
    <p class="hckui__typography__bodyL">
     2. The device(s) that open and shut the Smart Cabinet(s)
    </p>
    <p class="hckui__typography__bodyL">
     3. A middleman that can listen for incoming commands and distribute them to the smart devices that are listening for their activation command.
    </p>
    <p class="hckui__typography__bodyL">
     Below is a quick animated depiction of the plan/implementation of the project to convey the full idea before we get into it (it may take a bit to load):
    </p>
    <div class="carousel-images">
     <img class="carousel-image" src="0.jpg"/>
    </div>
    <h3 class="hckui__typography__h3 title-with-anchor" id="toc-automatic-cabinets-1">
     <p>
      <p class="hckui__typography__bodyL">
      </p>
     </p>
     <span>
      Automatic Cabinets
     </span>
    </h3>
    <p class="hckui__typography__bodyL">
     This first section is a bit tangential, but it's something I could see being an appealing alternative to some users so I wanted to include it before diving into our full Smart Cabinet and Smart Home setup.
    </p>
    <p class="hckui__typography__bodyL">
     The feedback specifically mentioned that voice activated controls would be a "game changer", so I will 100% be including that within this project.  However, what came to mind for me when considering what felt ideal for improving cabinetry for the mobility impaired, a simpler solution came to mind.  The reason being, if there are a lot of cabinets, they'll need different names for voice activation, or a lot of buttons if used in a different way like a phone app.  What if the cabinets could just automatically open when you needed them?  Different people have different needs and preferences, so if my focus is cabinets, I may as well offer multiple solutions.
    </p>
    <p class="hckui__typography__bodyL">
     <strong>
      <em>
       Proximity Driven Cabinetry
      </em>
     </strong>
    </p>
    <p class="hckui__typography__bodyL">
     The first solution I wanted to tackle was having cabinets open by proximity.  There would be a sweet spot in range, where if the cabinets were triggered to open from too far a distance cabinets would open at unwanted times and get quite annoying.  Too close and it would be difficult to navigate into range without then blocking the cabinet, especially with wheelchairs involved.  But, with that sweet spot in mind, which I estimated to be about a foot away and with the ultrasonic sensor placed beside where the cabinet opens, it could prove to be a very convenient solution.  When triggered, the cabinet opens and stays open for a minute before automatically closing.  This should give ample time to get whatever is needed from the cabinet, but if not the proximity sensor should detect the user's presence and remain open and this timing can easily be changed in the code.
    </p>
    <p class="hckui__typography__bodyL">
     The device is simple.  It's an ultrasonic sensor and a servo.  When the user is close, it opens for a minute, then closes if there is nothing in proximity.  This could be easily adjusted to add 2 servos per 1 sensor, or whatever else the given setup requires.  The code is included.
    </p>
    <p class="hckui__typography__bodyL">
     <span>
      Especially with a cruising baby in the house (meaning they walk by holding themselves up on walls and things like
     </span>
     <em>
      cabinets)
     </em>
     <span>
      it felt unwise to install this in my own home, so instead I did a quick demonstration of it with a toy chest I built that had previously been a part of an interactive mural I made.  It has a servo that opens and closes the toy chest, so I plugged in the arduino and gave it a whirl.
     </span>
    </p>
    <div class="carousel-images">
     <img class="carousel-image" src="1.jpg"/>
    </div>
    <h3 class="hckui__typography__h3 title-with-anchor" id="toc-now-we-ll-make-it-smart-2">
     <p>
      <p class="hckui__typography__bodyL">
      </p>
     </p>
     <span>
      Now We'll Make It Smart
     </span>
    </h3>
    <p class="hckui__typography__bodyL">
     As promised, it's time to make it Smart.  This time around I'm specifically using an ESP32 to make connecting to wifi easy.  The Seeed Studio XIAO ESP32S3 Sense is wifi enabled, so it can also be used as the microcontroller for your Smart Cabinets.  You would just choose the following board if you use it instead of a different ESP32.
    </p>
    <div class="carousel-images">
     <img class="carousel-image" src="2.jpg"/>
    </div>
    <p class="hckui__typography__bodyL">
     Now it's time for code!  We'll go more in depth on what exactly is on the other side of this to trigger the command the code is listening for in the first place, but for the time being what matters is that we link to an MQTT server and then listen for a specific message.  What I setup in the code was just "cabinet", which would then change the state of the cabinet to opened or closed.  The code is included.
    </p>
    <div class="carousel-images">
     <img class="carousel-image" src="3.jpg"/>
    </div>
    <p class="hckui__typography__bodyL">
     With this, the command to kick off sending the message in the first place can be triggered in various ways, including with voice commands.  Obviously the following won't work until the server side of everything is setup, but you can run the following line in a command prompt and it will trigger your cabinet servo to move:
    </p>
    <p class="hckui__typography__bodyL">
     <code>
      mosquitto_pub -h &lt;your server ip&gt; -t home/&lt;topic&gt; -m "cabinet" -u &lt;username&gt; -P &lt;password -p 1883
     </code>
    </p>
    <p class="hckui__typography__bodyL">
     The above command will make more sense once we get through the next section, but it felt logical to provide a test for our current code while we're discussing it.
    </p>
    <p class="hckui__typography__bodyL">
     <strong>
      <em>
       Voice Commands (Pt. 1)
      </em>
     </strong>
    </p>
    <p class="hckui__typography__bodyL">
     Just to feel as though I've fully tackled the Smart Cabinet, here's a way to easily go about integrating voice commands by using something called IFTTT.  I'll start by saying I don't currently need the pro version of IFTTT so I didn't run this myself but I'm pretty confident all information here is correct.  As we'll get to later, we will be also adding a completely different, completely custom way to go about including voice commands that has been fully tested.  This IFTTT setup is an easy to understand way to go about adding voice commands to devices you already own if you don't want the full solution I'm building out in this project, or if you just want multiple ways to activate your cabinets.
    </p>
    <p class="hckui__typography__bodyL">
     I personally have android and Google devices, so I begin with adding a voice command through Google Assistant.
    </p>
    <div class="carousel-images">
     <img class="carousel-image" src="4.jpg"/>
    </div>
    <p class="hckui__typography__bodyL">
     For the "that" portion of the "if this then that" (what IFTTT stands for), we will select webhook.  If you set it up as seen below, it should just work.
    </p>
    <div class="carousel-images">
     <img class="carousel-image" src="5.jpg"/>
    </div>
    <p class="hckui__typography__bodyL">
     The external ip address would be for the smart home device we're about to go through, since IFTTT works through external services.  If you don't want to use IFTTT or include an external ip, our solution will include a fully internal setup momentarily.
    </p>
    <p class="hckui__typography__bodyL">
     This brings us to what exactly is on the other side of the smart cabinet - the custom hub of the smart kitchen.
    </p>
    <h3 class="hckui__typography__h3 title-with-anchor" id="toc-smartifying-the-kitchen-3">
     <p>
      <p class="hckui__typography__bodyL">
      </p>
     </p>
     <span>
      Smartifying the Kitchen
     </span>
    </h3>
    <p class="hckui__typography__bodyL">
     <em>
      <strong>
       (because Smartifying is definitely a word)
      </strong>
     </em>
    </p>
    <p class="hckui__typography__bodyL">
     I received a CM4Stack Development Kit from M5Stack as part of the Build2gether challenge, which runs with a Raspberry Pi Compute Module 4.  This is the device I'll be utilizing to turn the kitchen (and my home in general, eventually) into a smart one.
    </p>
    <p class="hckui__typography__bodyL">
     My goal was to set it up so generically that I can easily add a new device and not need to change a single thing in the smart hub.  The short of it is I put together a python script that sets up a Flask server that waits for commands, which then publishes to an MQTT topic that runs on the same service.  This can then be easily received by devices like the ESP32 listening for the "cabinet" command.
    </p>
    <p class="hckui__typography__bodyL">
     <strong>
      Setup
     </strong>
    </p>
    <p class="hckui__typography__bodyL">
     Before we get to start coding, we have to do a bit of setup.  This is all done on the CM4Stack.  Thankfully, you can have the browser up within it so you can just copy paste a lot of the commands below.  Just update specific fields to be what you want, like your username and password.
    </p>
    <p class="hckui__typography__bodyL">
     <strong>
      Install and Configure Mosquitto (MQTT Broker)
     </strong>
     <span>
      :
     </span>
    </p>
    <p class="hckui__typography__bodyL">
     First, set up the Mosquitto MQTT broker by installing it:
    </p>
    <pre><code><span>sudo apt update</span><br/><span>sudo apt install -y mosquitto mosquitto-clients</span><br/><span>sudo systemctl start mosquitto</span><br/><span>sudo systemctl enable mosquitto</span></code></pre>
    <p class="hckui__typography__bodyL">
     Next, configure Mosquitto to listen on all network interfaces and set up authentication. Edit the Mosquitto configuration file:
    </p>
    <pre><code><span>sudo nano /etc/mosquitto/mosquitto.conf</span></code></pre>
    <p class="hckui__typography__bodyL">
     Add the following at the end of the file:
    </p>
    <pre><code><span>allow_anonymous false</span><br/><span>password_file /etc/mosquitto/passwd</span></code></pre>
    <p class="hckui__typography__bodyL">
     Create a password file and add a user (change your username in this one):
    </p>
    <pre><code><span>sudo mosquitto_passwd -c /etc/mosquitto/passwd &lt;username&gt;</span></code></pre>
    <p class="hckui__typography__bodyL">
     You'll then be prompted to set your password.  After that, restart Mosquitto to apply the changes:
    </p>
    <pre><code><span>sudo systemctl restart mosquitto</span></code></pre>
    <p class="hckui__typography__bodyL">
     <strong>
      Configure
     </strong>
     <strong>
      the Network
     </strong>
     <span>
      :
     </span>
    </p>
    <p class="hckui__typography__bodyL">
     Ensure the device has a static IP address by editing the DHCP client configuration file.  This makes it so that when you reboot, we don't have to update all the connected devices:
    </p>
    <pre><code><span>sudo nano /etc/dhcpcd.conf</span></code></pre>
    <p class="hckui__typography__bodyL">
     Add the following lines:
    </p>
    <pre><code><span>interface wlan0</span><br/><span>static ip_address=&lt;static_ip&gt;/24</span><br/><span>static routers=&lt;router_ip&gt;</span><br/><span>static domain_name_servers=&lt;dns_ip&gt;</span></code></pre>
    <p class="hckui__typography__bodyL">
     Reboot again:
    </p>
    <pre><code><span>sudo reboot</span></code></pre>
    <p class="hckui__typography__bodyL">
     <strong>
      Configure
     </strong>
     <strong>
      your Firewall
     </strong>
     <span>
      :
     </span>
    </p>
    <p class="hckui__typography__bodyL">
     To make sure everything works correctly, we need to make sure certain ports are open:
    </p>
    <pre><code><span>sudo apt install ufw</span><br/><span>sudo ufw allow 1883</span><br/><span>sudo ufw allow 5000</span><br/><span>sudo ufw enable</span></code></pre>
    <p class="hckui__typography__bodyL">
     <strong>
      Set
     </strong>
     <strong>
      The Environment Variables
     </strong>
     <span>
      :
     </span>
    </p>
    <p class="hckui__typography__bodyL">
     Finally, we have to set our environment variables that will be used by the Python script.  Obviously, update the values as needed below:
    </p>
    <pre><code><span>export MQTT_BROKER_ADDRESS="&lt;static ip&gt;"</span><br/><span>export MQTT_TOPIC="home/&lt;name of your topic&gt;"</span><br/><span>export HTTP_SERVER_PORT="5000"</span><br/><span>export MQTT_USERNAME="&lt;username&gt;"</span><br/><span>export MQTT_PASSWORD="&lt;password&gt;"</span></code></pre>
    <p class="hckui__typography__bodyL">
     At this point you should be ready to go and able to run the program we discussed at the start of this section.  The code is included in the project.  Just be sure the values are updated within the code to match what you setup just now and everything should work correctly right off the bat.
    </p>
    <h3 class="hckui__typography__h3 title-with-anchor" id="toc-more-cabinets-4">
     <p>
      <p class="hckui__typography__bodyL">
      </p>
     </p>
     <span>
      More Cabinets
     </span>
    </h3>
    <p class="hckui__typography__bodyL">
     This section will be short, but I figure it stands to reason that there would be more than 1 cabinet that needs to be made Smart.  The code for 1 cabinet can be easily changed to accommodate more, but I figure it's still easier to add more cabinets when the program is already setup for multiple cabinets.
    </p>
    <p class="hckui__typography__bodyL">
     Here, I've added a 2nd servo and expanded the program.  Instead of just "cabinet", we listen for specific cabinets.  So, the program will instead listen for "dishwasher cabinet" and "stove cabinet".  This feels like a more realistic representation of how this would actually all get utilized.
    </p>
    <p class="hckui__typography__bodyL">
     As noted in the section going through the Flask server setup, we don't need to do any modifications over there.  It will just work.
    </p>
    <h3 class="hckui__typography__h3 title-with-anchor" id="toc-custom-voice-commands-5">
     <p>
      <p class="hckui__typography__bodyL">
      </p>
     </p>
     <span>
      Custom Voice Commands
     </span>
    </h3>
    <p class="hckui__typography__bodyL">
     It's a good feeling to be able to control all aspects of projects like these.  Our devices can all just talking to each other with no reliance on external entities, unless we choose to add them, and that's nice.
    </p>
    <p class="hckui__typography__bodyL">
     <span>
      Similarly nice was the discovery I had partway through
     </span>
     <a class="hckui__typography__linkBlue" data-ha='{"eventName":"Clicked link","customProps":{"value":"my other Build2gether creation","href":"https://www.hackster.io/thedonutsorelse/a-smart-hiking-stick-for-the-visually-impaired-06ef51","type":"story","location":"story"},"clickOpts":{"delayRedirect":true}}' href="https://www.hackster.io/thedonutsorelse/a-smart-hiking-stick-for-the-visually-impaired-06ef51" rel="nofollow">
      my other Build2gether creation
     </a>
     <span>
      , which is that the
     </span>
     <strong>
      <em>
       <a class="hckui__typography__linkBlue" data-ha='{"eventName":"Clicked link","customProps":{"value":"UNIHIKER","href":"https://www.dfrobot.com/product-2691.html","type":"story","location":"story"},"clickOpts":{"delayRedirect":true}}' href="https://www.dfrobot.com/product-2691.html" rel="nofollow">
        UNIHIKER
       </a>
      </em>
     </strong>
     <span>
      has a built in microphone.  By setting up a simple python script, we can have the UNIHIKER serve as a way to run voice commands through the CM4Stack's Flask server we just setup, which then go to devices like the Smart Cabinet we just built.
     </span>
    </p>
    <p class="hckui__typography__bodyL">
     Like the other UNIHIKER project I have, I'm running it in Mind+.  We listen for voice commands and when we hear the word "butler", we send the subsequent words to our flask server.  This then goes out to the devices in the home, which includes our Smart Cabinet(s).  "Butler" acts as a trigger word, like how you say "Ok Google" or "Hey Siri".  This can be easily changed, but that came to mind as a fun one.
    </p>
    <p class="hckui__typography__bodyL">
     The only two libraries needed are:
    </p>
    <pre><code><span>pip install SpeechRecognition</span><br/><span>pip install paho-mqtt</span></code></pre>
    <p class="hckui__typography__bodyL">
     And those can be installed via the Library Management tab in Mind+.
    </p>
    <div class="carousel-images">
     <img class="carousel-image" src="6.jpg"/>
    </div>
    <p class="hckui__typography__bodyL">
     As with the Smart Hiking Stick project I did, you need to ssh into the UNIHIKER and run the following command or you'll run into errors with the Google api:
    </p>
    <p class="hckui__typography__bodyL">
     <code>
      sudo apt-get install flac
     </code>
    </p>
    <p class="hckui__typography__bodyL">
     One nice thing about this UNIHIKER program is there's a lot less going on than with the Smart Hiking Stick.  In that one, there was so much running simultaneously that I found that I needed to include a timeout for voice commands or it could just end up taking forever to process a command.  With this project, we can leave it without a timeout, which leads to faster times processing the commands.  As with the other parts of the project, the code is included.
    </p>
    <h3 class="hckui__typography__h3 title-with-anchor" id="toc-the-wrap-up-6">
     <p>
      <p class="hckui__typography__bodyL">
      </p>
     </p>
     <span>
      The Wrap Up
     </span>
    </h3>
    <p class="hckui__typography__bodyL">
     <span>
      We now have a fully operational set of Smart Cabinets, with the option of making them Automatic instead
     </span>
     <em>
      or
     </em>
     <em>
      additionally,
     </em>
     <span>
      a Smart Home Hub ready to go for future custom Smart Home projects, and the ability to control those custom Smart Home projects with voice commands.
     </span>
    </p>
    <p class="hckui__typography__bodyL">
     While the Smart Cabinet aspect of the project is built for others, I absolutely plan to build upon the Smart Home setup with additional custom devices.  And, as far as the Smart Cabinets themselves go, hopefully this setup gets put to use in helping people in a real world setting - that's the goal, at least!
    </p>
    <p class="hckui__typography__bodyL">
     I hope you enjoyed the project. Have a good one.
    </p>
   </div>
  </section>
  <div class="project-section-break">
  </div>
  <section id="schematics">
   <div class="project-section-title">
    <h2 class="hckui__typography__h2 title-with-anchor">
     <span>
      Schematics
     </span>
    </h2>
   </div>
   <div class="project-attachment">
    <div class="header">
     <div class="text">
      <h3 class="hckui__typography__h3">
       Automatic Cabinet Schematic
      </h3>
      <div class="hckui__typography__bodyS hckui__typography__pebble">
       This uses an ultrasonic sensor and a servo to automatically open and close a cabinet by proximity.
      </div>
     </div>
    </div>
    <div class="embed original boxed hckui__typography__textCenter">
     <img src="13.jpg"/>
    </div>
   </div>
   <div class="project-attachment">
    <div class="header">
     <div class="text">
      <h3 class="hckui__typography__h3">
       Smart Cabinets Schematic
      </h3>
      <div class="hckui__typography__bodyS hckui__typography__pebble">
       This controls 2 servos to demonstrate controlling multiple cabinets with an ESP32.
      </div>
     </div>
    </div>
    <div class="embed original boxed hckui__typography__textCenter">
     <img src="14.jpg"/>
    </div>
   </div>
  </section>
  <div class="project-section-break">
  </div>
  <section id="code">
   <div class="project-section-title">
    <h2 class="hckui__typography__h2 title-with-anchor">
     <span>
      Code
     </span>
    </h2>
   </div>
   <div class="project-attachment project-code-widget">
    <div class="tabs hckui__typography__bodyS">
     <ul>
      <li class="active">
       <a data-target="#code-widget-657296" href="javascript:void(0)">
        voice_controller.py
       </a>
      </li>
      <li>
       <a data-target="#code-widget-657306" href="javascript:void(0)">
        SmartCabinetsPlural_Generified.ino
       </a>
      </li>
      <li>
       <a data-target="#code-widget-657307" href="javascript:void(0)">
        smartCabinet_Generified.ino
       </a>
      </li>
      <li>
       <a data-target="#code-widget-657416" href="javascript:void(0)">
        automatic_cabinet.ino
       </a>
      </li>
      <li>
       <a data-target="#code-widget-657418" href="javascript:void(0)">
        smart_house.py
       </a>
      </li>
     </ul>
    </div>
    <div class="preview-container">
     <div class="preview-pane active" id="code-widget-657296">
      <div class="header">
       <div class="text">
        <div class="title">
         <h3 class="hckui__typography__h3">
          voice_controller.py
         </h3>
         <span class="hckui__typography__bodyS hckui__typography__pebble">
          Python
         </span>
        </div>
        <div class="comment">
         <div class="hckui__typography__bodyS hckui__typography__pebble">
          This runs on the UNIHIKER to listen for voice commands that can then communicate with the flask server and control our Smart Cabinets
         </div>
        </div>
       </div>
      </div>
      <div class="preview-body pygments-syntax all">
       <div class="highlight">
        <pre><span></span><span id="line-1"><span class="c1"># -*- coding: UTF-8 -*-</span>
</span><span id="line-2">
</span><span id="line-3"><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="line-4"><span class="kn">import</span> <span class="nn">speech_recognition</span> <span class="k">as</span> <span class="nn">sr</span>
</span><span id="line-5"><span class="kn">import</span> <span class="nn">time</span>
</span><span id="line-6"><span class="kn">import</span> <span class="nn">paho.mqtt.publish</span> <span class="k">as</span> <span class="nn">publish</span>
</span><span id="line-7">
</span><span id="line-8"><span class="c1"># MQTT Broker Settings</span>
</span><span id="line-9"><span class="n">BROKER</span> <span class="o">=</span> <span class="s2">"192.168.86.84"</span>  <span class="c1"># Change to your MQTT broker's IP address - this is the default one</span>
</span><span id="line-10"><span class="n">PORT</span> <span class="o">=</span> <span class="mi">1883</span>
</span><span id="line-11"><span class="n">TOPIC</span> <span class="o">=</span> <span class="s2">"home/&lt;topic&gt;"</span>
</span><span id="line-12"><span class="n">USERNAME</span> <span class="o">=</span> <span class="s2">"&lt;username&gt;"</span>  <span class="c1"># Change to your MQTT username</span>
</span><span id="line-13"><span class="n">PASSWORD</span> <span class="o">=</span> <span class="s2">"&lt;password&gt;"</span>  <span class="c1"># Change to your MQTT password</span>
</span><span id="line-14">
</span><span id="line-15"><span class="n">said_butler</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># To check if the last word we heard was "butler" so we know to send the next word(s) as a command</span>
</span><span id="line-16">
</span><span id="line-17"><span class="k">def</span> <span class="nf">listen_for_commands</span><span class="p">(</span><span class="n">recognizer</span><span class="p">,</span> <span class="n">audio</span><span class="p">):</span>
</span><span id="line-18">    <span class="k">global</span> <span class="n">said_butler</span>
</span><span id="line-19">    <span class="sd">"""Callback function that processes the audio as soon as it is available."""</span>
</span><span id="line-20">    <span class="k">try</span><span class="p">:</span>
</span><span id="line-21">        <span class="c1"># Recognize speech using Google's speech recognition</span>
</span><span id="line-22">        <span class="n">command</span> <span class="o">=</span> <span class="n">recognizer</span><span class="o">.</span><span class="n">recognize_google</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="line-23">        <span class="nb">print</span><span class="p">(</span><span class="s2">"You said:"</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="line-24">        
</span><span id="line-25">        <span class="c1"># Check if the command contains the wake word 'butler'</span>
</span><span id="line-26">        <span class="k">if</span> <span class="s1">'butler'</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
</span><span id="line-27">            <span class="n">said_butler</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Set flag to true to send next commands</span>
</span><span id="line-28">            <span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'butler'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c1"># Get everything after 'butler'</span>
</span><span id="line-29">
</span><span id="line-30">        <span class="k">if</span> <span class="n">said_butler</span> <span class="ow">and</span> <span class="n">command</span><span class="p">:</span>  <span class="c1"># If the flag is set and there is a command</span>
</span><span id="line-31">            <span class="nb">print</span><span class="p">(</span><span class="s2">"Command received:"</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span id="line-32">            <span class="n">words</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
</span><span id="line-33">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-34">                <span class="n">first_word</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-35">                <span class="nb">print</span><span class="p">(</span><span class="s2">"First word received:"</span><span class="p">,</span> <span class="n">first_word</span><span class="p">)</span>
</span><span id="line-36">                <span class="c1"># Send the first word as a separate command to the MQTT broker</span>
</span><span id="line-37">                <span class="n">publish</span><span class="o">.</span><span class="n">single</span><span class="p">(</span><span class="n">TOPIC</span><span class="p">,</span> <span class="n">first_word</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="n">BROKER</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">{</span><span class="s1">'username'</span><span class="p">:</span> <span class="n">USERNAME</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">:</span> <span class="n">PASSWORD</span><span class="p">})</span>
</span><span id="line-38">            
</span><span id="line-39">            <span class="c1"># Send the full command to the MQTT broker</span>
</span><span id="line-40">            <span class="n">publish</span><span class="o">.</span><span class="n">single</span><span class="p">(</span><span class="n">TOPIC</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">hostname</span><span class="o">=</span><span class="n">BROKER</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">{</span><span class="s1">'username'</span><span class="p">:</span> <span class="n">USERNAME</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">:</span> <span class="n">PASSWORD</span><span class="p">})</span>
</span><span id="line-41">            <span class="nb">print</span><span class="p">(</span><span class="s2">"Commands sent to the Flask server via MQTT."</span><span class="p">)</span>
</span><span id="line-42">            <span class="n">said_butler</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Reset flag after command is sent</span>
</span><span id="line-43">
</span><span id="line-44">    <span class="k">except</span> <span class="n">sr</span><span class="o">.</span><span class="n">UnknownValueError</span><span class="p">:</span>
</span><span id="line-45">        <span class="nb">print</span><span class="p">(</span><span class="s2">"Google Speech Recognition could not understand the audio"</span><span class="p">)</span>
</span><span id="line-46">    <span class="k">except</span> <span class="n">sr</span><span class="o">.</span><span class="n">RequestError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="line-47">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Could not request results from Google Speech Recognition service; </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-48">
</span><span id="line-49"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span id="line-50">    <span class="c1"># Initialize recognizer class (for recognizing the speech)</span>
</span><span id="line-51">    <span class="n">recognizer</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">Recognizer</span><span class="p">()</span>
</span><span id="line-52">    <span class="n">microphone</span> <span class="o">=</span> <span class="n">sr</span><span class="o">.</span><span class="n">Microphone</span><span class="p">()</span>
</span><span id="line-53">
</span><span id="line-54">    <span class="c1"># Adjust the recognizer sensitivity to ambient noise and record audio</span>
</span><span id="line-55">    <span class="k">with</span> <span class="n">microphone</span> <span class="k">as</span> <span class="n">source</span><span class="p">:</span>
</span><span id="line-56">        <span class="n">recognizer</span><span class="o">.</span><span class="n">adjust_for_ambient_noise</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="line-57">        <span class="nb">print</span><span class="p">(</span><span class="s2">"Set minimum energy threshold to:"</span><span class="p">,</span> <span class="n">recognizer</span><span class="o">.</span><span class="n">energy_threshold</span><span class="p">)</span>
</span><span id="line-58">        <span class="n">recognizer</span><span class="o">.</span><span class="n">pause_threshold</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># Adjust based on testing; default is 0.8 seconds</span>
</span><span id="line-59">        <span class="n">recognizer</span><span class="o">.</span><span class="n">non_speaking_duration</span> <span class="o">=</span> <span class="mf">0.4</span>  <span class="c1"># Adjust based on testing; default is 0.5 seconds</span>
</span><span id="line-60">
</span><span id="line-61">    <span class="c1"># Start listening in the background (non-blocking)</span>
</span><span id="line-62">    <span class="n">stop_listening</span> <span class="o">=</span> <span class="n">recognizer</span><span class="o">.</span><span class="n">listen_in_background</span><span class="p">(</span><span class="n">microphone</span><span class="p">,</span> <span class="n">listen_for_commands</span><span class="p">,</span> <span class="n">phrase_time_limit</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span><span id="line-63">
</span><span id="line-64">    <span class="c1"># Keep the main thread alive, or the background listener will stop</span>
</span><span id="line-65">    <span class="k">try</span><span class="p">:</span>
</span><span id="line-66">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="line-67">            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Sleep briefly to limit CPU usage</span>
</span><span id="line-68">    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="line-69">        <span class="n">stop_listening</span><span class="p">(</span><span class="n">wait_for_stop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># Stop listening when Ctrl+C is pressed</span>
</span><span id="line-70">        <span class="nb">print</span><span class="p">(</span><span class="s2">"Stopped listening..."</span><span class="p">)</span>
</span><span id="line-71">
</span><span id="line-72"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span><span id="line-73">    <span class="n">main</span><span class="p">()</span>
</span></pre>
       </div>
      </div>
     </div>
     <div class="preview-pane" id="code-widget-657306">
      <div class="header">
       <div class="text">
        <div class="title">
         <h3 class="hckui__typography__h3">
          SmartCabinetsPlural_Generified.ino
         </h3>
         <span class="hckui__typography__bodyS hckui__typography__pebble">
          Arduino
         </span>
        </div>
        <div class="comment">
         <div class="hckui__typography__bodyS hckui__typography__pebble">
          This is an example of how to have one microcontroller run multiple smart cabinets, as well as demonstrating the logic tweaks for handling multiple cabinets in general.
         </div>
        </div>
       </div>
      </div>
      <div class="preview-body pygments-syntax arduino">
       <div class="highlight">
        <pre><span></span><span id="line-1"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WiFi.h&gt;</span><span class="cp"></span>
</span><span id="line-2"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;PubSubClient.h&gt;</span><span class="cp"></span>
</span><span id="line-3"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ESP32Servo.h&gt;</span><span class="cp"></span>
</span><span id="line-4">
</span><span id="line-5"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;Your Wifi&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-6"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;Your wifi password&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-7">
</span><span id="line-8"><span class="c1">//MQTT Broker settings</span>
</span><span id="line-9"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;server ip&gt;"</span><span class="p">;</span><span class="w">  </span><span class="c1">// MQTT broker IP address</span>
</span><span id="line-10"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">mqtt_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1883</span><span class="p">;</span><span class="w"></span>
</span><span id="line-11"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;usernames&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-12"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;password&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-13"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"home/&lt;topic&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-14">
</span><span id="line-15"><span class="c1">//Servo settings</span>
</span><span id="line-16"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">servoPinDishwasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"></span>
</span><span id="line-17"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">servoPinStove</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">33</span><span class="p">;</span><span class="w"></span>
</span><span id="line-18"><span class="nf">Servo</span><span class="w"> </span><span class="n">servoDishwasher</span><span class="p">;</span><span class="w"></span>
</span><span id="line-19"><span class="nf">Servo</span><span class="w"> </span><span class="n">servoStove</span><span class="p">;</span><span class="w"></span>
</span><span id="line-20"><span class="kr">int</span><span class="w"> </span><span class="n">servoOpenPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">180</span><span class="p">;</span><span class="w">  </span><span class="c1">// Position to open the cabinet - change as needed</span>
</span><span id="line-21"><span class="kr">int</span><span class="w"> </span><span class="n">servoClosePosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">// Position to close the cabinet - change as needed</span>
</span><span id="line-22"><span class="kr">bool</span><span class="w"> </span><span class="n">isDishwasherOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">false</span><span class="p">;</span><span class="w"></span>
</span><span id="line-23"><span class="kr">bool</span><span class="w"> </span><span class="n">isStoveOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">false</span><span class="p">;</span><span class="w"></span>
</span><span id="line-24">
</span><span id="line-25"><span class="nf">WiFiClient</span><span class="w"> </span><span class="n">espClient</span><span class="p">;</span><span class="w"></span>
</span><span id="line-26"><span class="n">PubSubClient</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">espClient</span><span class="p">);</span><span class="w"></span>
</span><span id="line-27">
</span><span id="line-28"><span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-29"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span><span class="w"></span>
</span><span id="line-30"><span class="w">  </span><span class="nf">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="w"></span>
</span><span id="line-31">
</span><span id="line-32"><span class="w">  </span><span class="n">servoDishwasher</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">servoPinDishwasher</span><span class="p">);</span><span class="w"></span>
</span><span id="line-33"><span class="w">  </span><span class="n">servoStove</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">servoPinStove</span><span class="p">);</span><span class="w"></span>
</span><span id="line-34"><span class="w">  </span><span class="n">servoDishwasher</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">servoClosePosition</span><span class="p">);</span><span class="w"></span>
</span><span id="line-35"><span class="w">  </span><span class="n">servoStove</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">servoClosePosition</span><span class="p">);</span><span class="w"></span>
</span><span id="line-36">
</span><span id="line-37"><span class="w">  </span><span class="n">setup_wifi</span><span class="p">();</span><span class="w"></span>
</span><span id="line-38"><span class="w">  </span><span class="n">client</span><span class="p">.</span><span class="n">setServer</span><span class="p">(</span><span class="n">mqtt_server</span><span class="p">,</span><span class="w"> </span><span class="n">mqtt_port</span><span class="p">);</span><span class="w"></span>
</span><span id="line-39"><span class="w">  </span><span class="n">client</span><span class="p">.</span><span class="n">setCallback</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span><span class="w"></span>
</span><span id="line-40"><span class="p">}</span><span class="w"></span>
</span><span id="line-41">
</span><span id="line-42"><span class="kr">void</span><span class="w"> </span><span class="nf">setup_wifi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-43"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"Connecting to "</span><span class="p">);</span><span class="w"></span>
</span><span id="line-44"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span><span class="w"></span>
</span><span id="line-45"><span class="w">  </span><span class="nf">WiFi</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span><span class="w"></span>
</span><span id="line-46">
</span><span id="line-47"><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nf">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">WL_CONNECTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-48"><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span><span class="w"></span>
</span><span id="line-49"><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span><span class="w"></span>
</span><span id="line-50"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-51"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"WiFi connected"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-52"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"IP address: "</span><span class="p">);</span><span class="w"></span>
</span><span id="line-53"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="nf">WiFi</span><span class="p">.</span><span class="nf">localIP</span><span class="p">());</span><span class="w"></span>
</span><span id="line-54"><span class="p">}</span><span class="w"></span>
</span><span id="line-55">
</span><span id="line-56"><span class="kr">void</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="kr">byte</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-57"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"Message arrived on topic: "</span><span class="p">);</span><span class="w"></span>
</span><span id="line-58"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="n">topic</span><span class="p">);</span><span class="w"></span>
</span><span id="line-59"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">". Message: "</span><span class="p">);</span><span class="w"></span>
</span><span id="line-60"><span class="w">  </span><span class="kr">String</span><span class="w"> </span><span class="n">messageTemp</span><span class="p">;</span><span class="w"></span>
</span><span id="line-61">
</span><span id="line-62"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-63"><span class="w">    </span><span class="n">messageTemp</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="kr">char</span><span class="p">)</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
</span><span id="line-64"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-65"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="n">messageTemp</span><span class="p">);</span><span class="w"></span>
</span><span id="line-66">
</span><span id="line-67"><span class="w">  </span><span class="c1">// Check to use specific cabinets</span>
</span><span id="line-68"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">messageTemp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"dishwasher cabinet"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-69"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isDishwasherOpen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-70"><span class="w">      </span><span class="n">servoDishwasher</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">servoClosePosition</span><span class="p">);</span><span class="w"></span>
</span><span id="line-71"><span class="w">      </span><span class="n">isDishwasherOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">false</span><span class="p">;</span><span class="w"></span>
</span><span id="line-72"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Dishwasher Cabinet closed"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-73"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-74"><span class="w">      </span><span class="n">servoDishwasher</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">servoOpenPosition</span><span class="p">);</span><span class="w"></span>
</span><span id="line-75"><span class="w">      </span><span class="n">isDishwasherOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">true</span><span class="p">;</span><span class="w"></span>
</span><span id="line-76"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Dishwasher Cabinet opened"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-77"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span id="line-78"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">messageTemp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"stove cabinet"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-79"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isStoveOpen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-80"><span class="w">      </span><span class="n">servoStove</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">servoClosePosition</span><span class="p">);</span><span class="w"></span>
</span><span id="line-81"><span class="w">      </span><span class="n">isStoveOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">false</span><span class="p">;</span><span class="w"></span>
</span><span id="line-82"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Stove Cabinet closed"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-83"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-84"><span class="w">      </span><span class="n">servoStove</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">servoOpenPosition</span><span class="p">);</span><span class="w"></span>
</span><span id="line-85"><span class="w">      </span><span class="n">isStoveOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">true</span><span class="p">;</span><span class="w"></span>
</span><span id="line-86"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Stove Cabinet opened"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-87"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span id="line-88"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-89"><span class="p">}</span><span class="w"></span>
</span><span id="line-90">
</span><span id="line-91"><span class="kr">void</span><span class="w"> </span><span class="nf">reconnect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-92"><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="nf">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-93"><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"Attempting MQTT connection..."</span><span class="p">);</span><span class="w"></span>
</span><span id="line-94"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s">"ESP32Client"</span><span class="p">,</span><span class="w"> </span><span class="n">mqtt_user</span><span class="p">,</span><span class="w"> </span><span class="n">mqtt_password</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-95"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"</span><span class="nf">connected</span><span class="s">"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-96"><span class="w">      </span><span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">mqtt_topic</span><span class="p">);</span><span class="w"></span>
</span><span id="line-97"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-98"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"failed, rc="</span><span class="p">);</span><span class="w"></span>
</span><span id="line-99"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">state</span><span class="p">());</span><span class="w"></span>
</span><span id="line-100"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">" try again in 5 seconds"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-101"><span class="w">      </span><span class="nf">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="w"></span>
</span><span id="line-102"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span id="line-103"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-104"><span class="p">}</span><span class="w"></span>
</span><span id="line-105">
</span><span id="line-106"><span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-107"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="nf">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-108"><span class="w">    </span><span class="n">reconnect</span><span class="p">();</span><span class="w"></span>
</span><span id="line-109"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-110"><span class="w">  </span><span class="n">client</span><span class="p">.</span><span class="nb">loop</span><span class="p">();</span><span class="w"></span>
</span><span id="line-111"><span class="p">}</span><span class="w"></span>
</span></pre>
       </div>
      </div>
     </div>
     <div class="preview-pane" id="code-widget-657307">
      <div class="header">
       <div class="text">
        <div class="title">
         <h3 class="hckui__typography__h3">
          smartCabinet_Generified.ino
         </h3>
         <span class="hckui__typography__bodyS hckui__typography__pebble">
          Arduino
         </span>
        </div>
        <div class="comment">
         <div class="hckui__typography__bodyS hckui__typography__pebble">
          This is the code for a singular smart cabinet, run on an ESP32.
         </div>
        </div>
       </div>
      </div>
      <div class="preview-body pygments-syntax arduino">
       <div class="highlight">
        <pre><span></span><span id="line-1"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;WiFi.h&gt;</span><span class="cp"></span>
</span><span id="line-2"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;PubSubClient.h&gt;</span><span class="cp"></span>
</span><span id="line-3"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ESP32Servo.h&gt;</span><span class="cp"></span>
</span><span id="line-4">
</span><span id="line-5"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;Your Wifi&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-6"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;Your wifi password&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-7">
</span><span id="line-8"><span class="c1">//MQTT Broker settings</span>
</span><span id="line-9"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;server ip&gt;"</span><span class="p">;</span><span class="w">  </span><span class="c1">// MQTT broker IP address</span>
</span><span id="line-10"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">mqtt_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1883</span><span class="p">;</span><span class="w"></span>
</span><span id="line-11"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;usernames&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-12"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"&lt;password&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-13"><span class="kr">const</span><span class="w"> </span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">mqtt_topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"home/&lt;topic&gt;"</span><span class="p">;</span><span class="w"></span>
</span><span id="line-14">
</span><span id="line-15"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">servoPin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span><span class="w"></span>
</span><span id="line-16"><span class="nf">Servo</span><span class="w"> </span><span class="n">myServo</span><span class="p">;</span><span class="w"></span>
</span><span id="line-17"><span class="kr">int</span><span class="w"> </span><span class="n">servoOpenPosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">180</span><span class="p">;</span><span class="w">  </span><span class="c1">// Position to open the cabinet - change as needed</span>
</span><span id="line-18"><span class="kr">int</span><span class="w"> </span><span class="n">servoClosePosition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">// Position to close the cabinet - change as needed</span>
</span><span id="line-19"><span class="kr">bool</span><span class="w"> </span><span class="n">isCabinetOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">false</span><span class="p">;</span><span class="w">   </span><span class="c1">// Initial state of the cabinet</span>
</span><span id="line-20">
</span><span id="line-21"><span class="nf">WiFiClient</span><span class="w"> </span><span class="n">espClient</span><span class="p">;</span><span class="w"></span>
</span><span id="line-22"><span class="n">PubSubClient</span><span class="w"> </span><span class="nf">client</span><span class="p">(</span><span class="n">espClient</span><span class="p">);</span><span class="w"></span>
</span><span id="line-23">
</span><span id="line-24"><span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-25"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span><span class="w">  </span><span class="c1">// Lowering baud rate for troubleshooting</span>
</span><span id="line-26"><span class="w">  </span><span class="nf">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="w"></span>
</span><span id="line-27">
</span><span id="line-28"><span class="w">  </span><span class="n">myServo</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">servoPin</span><span class="p">);</span><span class="w"></span>
</span><span id="line-29"><span class="w">  </span><span class="n">myServo</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">servoClosePosition</span><span class="p">);</span><span class="w">  </span><span class="c1">// Ensure servo starts in the closed position</span>
</span><span id="line-30">
</span><span id="line-31"><span class="w">  </span><span class="n">setup_wifi</span><span class="p">();</span><span class="w"></span>
</span><span id="line-32"><span class="w">  </span><span class="n">client</span><span class="p">.</span><span class="n">setServer</span><span class="p">(</span><span class="n">mqtt_server</span><span class="p">,</span><span class="w"> </span><span class="n">mqtt_port</span><span class="p">);</span><span class="w"></span>
</span><span id="line-33"><span class="w">  </span><span class="n">client</span><span class="p">.</span><span class="n">setCallback</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span><span class="w"></span>
</span><span id="line-34"><span class="p">}</span><span class="w"></span>
</span><span id="line-35">
</span><span id="line-36"><span class="kr">void</span><span class="w"> </span><span class="nf">setup_wifi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-37"><span class="w">  </span><span class="nf">delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"></span>
</span><span id="line-38"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">();</span><span class="w"></span>
</span><span id="line-39"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"Connecting to "</span><span class="p">);</span><span class="w"></span>
</span><span id="line-40"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span><span class="w"></span>
</span><span id="line-41">
</span><span id="line-42"><span class="w">  </span><span class="nf">WiFi</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span><span class="w"></span>
</span><span id="line-43">
</span><span id="line-44"><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nf">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">WL_CONNECTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-45"><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span><span class="w"></span>
</span><span id="line-46"><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span><span class="w"></span>
</span><span id="line-47"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-48">
</span><span id="line-49"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">""</span><span class="p">);</span><span class="w"></span>
</span><span id="line-50"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"WiFi connected"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-51"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"IP address: "</span><span class="p">);</span><span class="w"></span>
</span><span id="line-52"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="nf">WiFi</span><span class="p">.</span><span class="nf">localIP</span><span class="p">());</span><span class="w"></span>
</span><span id="line-53"><span class="p">}</span><span class="w"></span>
</span><span id="line-54">
</span><span id="line-55"><span class="kr">void</span><span class="w"> </span><span class="nf">callback</span><span class="p">(</span><span class="kr">char</span><span class="o">*</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="kr">byte</span><span class="o">*</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="kr">unsigned</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-56"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"Message arrived on topic: "</span><span class="p">);</span><span class="w"></span>
</span><span id="line-57"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="n">topic</span><span class="p">);</span><span class="w"></span>
</span><span id="line-58"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">". Message: "</span><span class="p">);</span><span class="w"></span>
</span><span id="line-59"><span class="w">  </span><span class="kr">String</span><span class="w"> </span><span class="n">messageTemp</span><span class="p">;</span><span class="w"></span>
</span><span id="line-60">
</span><span id="line-61"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kr">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-62"><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">((</span><span class="kr">char</span><span class="p">)</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
</span><span id="line-63"><span class="w">    </span><span class="n">messageTemp</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="p">(</span><span class="kr">char</span><span class="p">)</span><span class="n">message</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
</span><span id="line-64"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-65"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">();</span><span class="w"></span>
</span><span id="line-66">
</span><span id="line-67"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">messageTemp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"cabinet"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-68"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isCabinetOpen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-69"><span class="w">      </span><span class="n">myServo</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">servoClosePosition</span><span class="p">);</span><span class="w"></span>
</span><span id="line-70"><span class="w">      </span><span class="n">isCabinetOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">false</span><span class="p">;</span><span class="w"></span>
</span><span id="line-71"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Cabinet closed"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-72"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-73"><span class="w">      </span><span class="n">myServo</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">servoOpenPosition</span><span class="p">);</span><span class="w"></span>
</span><span id="line-74"><span class="w">      </span><span class="n">isCabinetOpen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">true</span><span class="p">;</span><span class="w"></span>
</span><span id="line-75"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Cabinet opened"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-76"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span id="line-77"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-78"><span class="p">}</span><span class="w"></span>
</span><span id="line-79">
</span><span id="line-80"><span class="kr">void</span><span class="w"> </span><span class="nf">reconnect</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-81"><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="nf">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-82"><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"Attempting MQTT connection..."</span><span class="p">);</span><span class="w"></span>
</span><span id="line-83"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="s">"ESP32Client"</span><span class="p">,</span><span class="w"> </span><span class="n">mqtt_user</span><span class="p">,</span><span class="w"> </span><span class="n">mqtt_password</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-84"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"</span><span class="nf">connected</span><span class="s">"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-85"><span class="w">      </span><span class="c1">// Subscribe to the topic</span>
</span><span id="line-86"><span class="w">      </span><span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">mqtt_topic</span><span class="p">);</span><span class="w"></span>
</span><span id="line-87"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-88"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"failed, rc="</span><span class="p">);</span><span class="w"></span>
</span><span id="line-89"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">state</span><span class="p">());</span><span class="w"></span>
</span><span id="line-90"><span class="w">      </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">" try again in 5 seconds"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-91">
</span><span id="line-92"><span class="w">      </span><span class="nf">delay</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="w"></span>
</span><span id="line-93"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span id="line-94"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-95"><span class="p">}</span><span class="w"></span>
</span><span id="line-96">
</span><span id="line-97"><span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-98"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="nf">connected</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-99"><span class="w">    </span><span class="n">reconnect</span><span class="p">();</span><span class="w"></span>
</span><span id="line-100"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-101"><span class="w">  </span><span class="n">client</span><span class="p">.</span><span class="nb">loop</span><span class="p">();</span><span class="w"></span>
</span><span id="line-102"><span class="p">}</span><span class="w"></span>
</span></pre>
       </div>
      </div>
     </div>
     <div class="preview-pane" id="code-widget-657416">
      <div class="header">
       <div class="text">
        <div class="title">
         <h3 class="hckui__typography__h3">
          automatic_cabinet.ino
         </h3>
         <span class="hckui__typography__bodyS hckui__typography__pebble">
          Arduino
         </span>
        </div>
        <div class="comment">
         <div class="hckui__typography__bodyS hckui__typography__pebble">
          This is the setup for an automatic cabinet that opens based on proximity and shuts after a given amount of time.
         </div>
        </div>
       </div>
      </div>
      <div class="preview-body pygments-syntax arduino">
       <div class="highlight">
        <pre><span></span><span id="line-1"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Servo.h&gt;</span><span class="cp"></span>
</span><span id="line-2">
</span><span id="line-3"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">trigPin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w"></span>
</span><span id="line-4"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">echoPin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
</span><span id="line-5"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">servoPin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="p">;</span><span class="w"></span>
</span><span id="line-6">
</span><span id="line-7"><span class="nf">Servo</span><span class="w"> </span><span class="n">myServo</span><span class="p">;</span><span class="w"></span>
</span><span id="line-8">
</span><span id="line-9"><span class="c1">//These are the angles that were good for my setup - change based on what works for yours!</span>
</span><span id="line-10"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">openAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span id="line-11"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">closeAngle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">90</span><span class="p">;</span><span class="w"></span>
</span><span id="line-12">
</span><span id="line-13"><span class="kr">const</span><span class="w"> </span><span class="kr">int</span><span class="w"> </span><span class="n">distanceThreshold</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span><span class="w"> </span><span class="c1">//Setting the threshold to around 1 ft</span>
</span><span id="line-14">
</span><span id="line-15"><span class="kr">long</span><span class="w"> </span><span class="nf">getDistance</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-16"><span class="w">  </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="n">trigPin</span><span class="p">,</span><span class="w"> </span><span class="kr">LOW</span><span class="p">);</span><span class="w"></span>
</span><span id="line-17"><span class="w">  </span><span class="nf">delayMicroseconds</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"></span>
</span><span id="line-18"><span class="w">  </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="n">trigPin</span><span class="p">,</span><span class="w"> </span><span class="kr">HIGH</span><span class="p">);</span><span class="w"></span>
</span><span id="line-19"><span class="w">  </span><span class="nf">delayMicroseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span><span class="w"></span>
</span><span id="line-20"><span class="w">  </span><span class="nf">digitalWrite</span><span class="p">(</span><span class="n">trigPin</span><span class="p">,</span><span class="w"> </span><span class="kr">LOW</span><span class="p">);</span><span class="w"></span>
</span><span id="line-21">
</span><span id="line-22"><span class="w">  </span><span class="kr">long</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">pulseIn</span><span class="p">(</span><span class="n">echoPin</span><span class="p">,</span><span class="w"> </span><span class="kr">HIGH</span><span class="p">);</span><span class="w"></span>
</span><span id="line-23"><span class="w">  </span><span class="kr">long</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.034</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">//Convert to cm</span>
</span><span id="line-24">
</span><span id="line-25"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">distance</span><span class="p">;</span><span class="w"></span>
</span><span id="line-26"><span class="p">}</span><span class="w"></span>
</span><span id="line-27">
</span><span id="line-28"><span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-29"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span><span class="w"></span>
</span><span id="line-30">
</span><span id="line-31"><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">trigPin</span><span class="p">,</span><span class="w"> </span><span class="kr">OUTPUT</span><span class="p">);</span><span class="w"></span>
</span><span id="line-32"><span class="w">  </span><span class="nf">pinMode</span><span class="p">(</span><span class="n">echoPin</span><span class="p">,</span><span class="w"> </span><span class="kr">INPUT</span><span class="p">);</span><span class="w"></span>
</span><span id="line-33"><span class="w">  </span><span class="n">myServo</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">servoPin</span><span class="p">);</span><span class="w"></span>
</span><span id="line-34">
</span><span id="line-35"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Setup complete."</span><span class="p">);</span><span class="w"></span>
</span><span id="line-36"><span class="p">}</span><span class="w"></span>
</span><span id="line-37">
</span><span id="line-38"><span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-39"><span class="w">  </span><span class="kr">long</span><span class="w"> </span><span class="n">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getDistance</span><span class="p">();</span><span class="w"></span>
</span><span id="line-40">
</span><span id="line-41"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="s">"Distance: "</span><span class="p">);</span><span class="w"></span>
</span><span id="line-42"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">print</span><span class="p">(</span><span class="n">distance</span><span class="p">);</span><span class="w"></span>
</span><span id="line-43"><span class="w">  </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">" cm"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-44">
</span><span id="line-45"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">distance</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">distanceThreshold</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-46"><span class="w">    </span><span class="n">myServo</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">openAngle</span><span class="p">);</span><span class="w"></span>
</span><span id="line-47"><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Opening cabinet"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-48"><span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">60000</span><span class="p">);</span><span class="w"> </span><span class="c1">//Sleep for 1 minute to leave the cabinet open that long</span>
</span><span id="line-49"><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Done sleeping."</span><span class="p">);</span><span class="w"></span>
</span><span id="line-50"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span id="line-51"><span class="w">    </span><span class="n">myServo</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">closeAngle</span><span class="p">);</span><span class="w"></span>
</span><span id="line-52"><span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Closing cabinet"</span><span class="p">);</span><span class="w"></span>
</span><span id="line-53"><span class="w">  </span><span class="p">}</span><span class="w"></span>
</span><span id="line-54">
</span><span id="line-55"><span class="w">  </span><span class="nf">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span><span class="w"> </span><span class="c1">//Half a second delay</span>
</span><span id="line-56"><span class="p">}</span><span class="w"></span>
</span></pre>
       </div>
      </div>
     </div>
     <div class="preview-pane" id="code-widget-657418">
      <div class="header">
       <div class="text">
        <div class="title">
         <h3 class="hckui__typography__h3">
          smart_house.py
         </h3>
         <span class="hckui__typography__bodyS hckui__typography__pebble">
          Python
         </span>
        </div>
        <div class="comment">
         <div class="hckui__typography__bodyS hckui__typography__pebble">
          This is what we use to run our Flask server on the CM4Stack.  This acts as the middleman between giving the voice commands and the Smart Cabinets.
         </div>
        </div>
       </div>
      </div>
      <div class="preview-body pygments-syntax all">
       <div class="highlight">
        <pre><span></span><span id="line-1"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
</span><span id="line-2"><span class="kn">import</span> <span class="nn">paho.mqtt.client</span> <span class="k">as</span> <span class="nn">mqtt</span>
</span><span id="line-3"><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="line-4"><span class="kn">import</span> <span class="nn">os</span>
</span><span id="line-5">
</span><span id="line-6"><span class="c1"># Configuration parameters</span>
</span><span id="line-7"><span class="n">broker_address</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'MQTT_BROKER_ADDRESS'</span><span class="p">,</span> <span class="s1">'192.168.86.84'</span><span class="p">)</span>  <span class="c1"># Default to internal IP address</span>
</span><span id="line-8"><span class="n">mqtt_topic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'MQTT_TOPIC'</span><span class="p">,</span> <span class="s1">'home/&lt;topic&gt;'</span><span class="p">)</span>
</span><span id="line-9"><span class="n">http_server_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'HTTP_SERVER_PORT'</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>
</span><span id="line-10"><span class="n">mqtt_username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'MQTT_USERNAME'</span><span class="p">,</span> <span class="s1">'&lt;username&gt;'</span><span class="p">)</span>
</span><span id="line-11"><span class="n">mqtt_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'MQTT_PASSWORD'</span><span class="p">,</span> <span class="s1">'&lt;password&gt;'</span><span class="p">)</span>
</span><span id="line-12">
</span><span id="line-13"><span class="c1"># Create Flask app</span>
</span><span id="line-14"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="line-15">
</span><span id="line-16"><span class="c1"># Setup logging</span>
</span><span id="line-17"><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="line-18">
</span><span id="line-19"><span class="c1"># MQTT setup</span>
</span><span id="line-20"><span class="n">mqtt_client</span> <span class="o">=</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">client_id</span><span class="o">=</span><span class="s2">"&lt;client id&gt;"</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">mqtt</span><span class="o">.</span><span class="n">MQTTv311</span><span class="p">)</span>
</span><span id="line-21"><span class="n">mqtt_client</span><span class="o">.</span><span class="n">username_pw_set</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">mqtt_username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">mqtt_password</span><span class="p">)</span>
</span><span id="line-22">
</span><span id="line-23"><span class="c1"># Define on_connect callback</span>
</span><span id="line-24"><span class="k">def</span> <span class="nf">on_connect</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rc</span><span class="p">):</span>
</span><span id="line-25">    <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-26">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Connected to MQTT Broker"</span><span class="p">)</span>
</span><span id="line-27">        <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">mqtt_topic</span><span class="p">)</span>
</span><span id="line-28">    <span class="k">elif</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span><span id="line-29">        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">"Authentication failed - check username and password"</span><span class="p">)</span>
</span><span id="line-30">    <span class="k">else</span><span class="p">:</span>
</span><span id="line-31">        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to connect, return code </span><span class="si">{</span><span class="n">rc</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-32">
</span><span id="line-33"><span class="c1"># Define on_message callback</span>
</span><span id="line-34"><span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
</span><span id="line-35">    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Received message: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2"> on topic </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">topic</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-36">
</span><span id="line-37"><span class="n">mqtt_client</span><span class="o">.</span><span class="n">on_connect</span> <span class="o">=</span> <span class="n">on_connect</span>
</span><span id="line-38"><span class="n">mqtt_client</span><span class="o">.</span><span class="n">on_message</span> <span class="o">=</span> <span class="n">on_message</span>
</span><span id="line-39">
</span><span id="line-40"><span class="k">try</span><span class="p">:</span>
</span><span id="line-41">    <span class="n">mqtt_client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">broker_address</span><span class="p">)</span>
</span><span id="line-42">    <span class="n">mqtt_client</span><span class="o">.</span><span class="n">loop_start</span><span class="p">()</span>
</span><span id="line-43"><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="line-44">    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to connect to MQTT Broker: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-45">
</span><span id="line-46"><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">'/command'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">'POST'</span><span class="p">])</span>
</span><span id="line-47"><span class="k">def</span> <span class="nf">handle_command</span><span class="p">():</span>
</span><span id="line-48">    <span class="k">try</span><span class="p">:</span>
</span><span id="line-49">        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
</span><span id="line-50">        <span class="n">action</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'action'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
</span><span id="line-51">        <span class="k">if</span> <span class="n">action</span><span class="p">:</span>
</span><span id="line-52">            <span class="n">mqtt_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">mqtt_topic</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
</span><span id="line-53">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Command '</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">' sent to MQTT topic."</span><span class="p">)</span>
</span><span id="line-54">            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"success"</span><span class="p">,</span> <span class="s2">"message"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"Command '</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">' sent to MQTT topic."</span><span class="p">}),</span> <span class="mi">200</span>
</span><span id="line-55">        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">"No action specified in the command."</span><span class="p">)</span>
</span><span id="line-56">        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"error"</span><span class="p">,</span> <span class="s2">"message"</span><span class="p">:</span> <span class="s2">"No action specified in the command."</span><span class="p">}),</span> <span class="mi">400</span>
</span><span id="line-57">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="line-58">        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error handling command: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-59">        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">"status"</span><span class="p">:</span> <span class="s2">"error"</span><span class="p">,</span> <span class="s2">"message"</span><span class="p">:</span> <span class="s2">"Failed to process command."</span><span class="p">}),</span> <span class="mi">500</span>
</span><span id="line-60">
</span><span id="line-61"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
</span><span id="line-62">    <span class="k">try</span><span class="p">:</span>
</span><span id="line-63">        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">http_server_port</span><span class="p">)</span>
</span><span id="line-64">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="line-65">        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Exception occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-66">    <span class="k">finally</span><span class="p">:</span>
</span><span id="line-67">        <span class="n">mqtt_client</span><span class="o">.</span><span class="n">loop_stop</span><span class="p">()</span>
</span><span id="line-68">        <span class="n">mqtt_client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span></pre>
       </div>
      </div>
     </div>
    </div>
   </div>
  </section>
  <div class="project-section-break">
  </div>
  <div class="project-section-break">
  </div>
 </div>
</div>
